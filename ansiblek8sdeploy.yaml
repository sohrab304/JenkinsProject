---
  - name: Deploy webserver on Kubernetes
    hosts: webservers
    become: yes
    become_method: sudo
    remote_user: root
    become_user: root
########################################################
    vars:
      container_name: localhost:5000/web_app
      container_version: :v2
      K8s_yaml: /opt/docker/k8swebappdeploy.yaml
 ########################################################
    gather_facts: false
    tasks:

      - name: Build Docker image
        shell: docker build -t '{{ container_name }}''{{ container_version }}' .
        args:
          chdir: /opt/docker

      - name: Docker push to local registry in microk8s
        shell: docker push '{{ container_name }}''{{ container_version }}'

      - name: Kubernetes Deploy update
        shell: /usr/bin/kubectl apply -f '{{ K8s_yaml }}'
      
      - name: remove docker image
        ignore_errors: yes
        shell: docker image rm -f '{{ container_name }}''{{ container_version }}' 
